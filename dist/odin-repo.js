"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.parseVersion = exports.getLatestRelease = exports.findRelease = exports.downloadOdinRelease = exports.getTestingModule = exports.ODIN_STREAMS = void 0;
const utils_1 = require("./utils");
exports.ODIN_STREAMS = ['dev'];
const MONTH_REGEX = /^(0[1-9]|1[1-2])$/;
const YEAR_REGEX = /^\d{4}$/;
const m = {
    parseVersion(str) {
        const split = str.split('-');
        if (split.length !== 3) {
            throw new Error('Cannot parse Odin version (wrong number of parts)');
        }
        const [stream, year, month] = split;
        if (!exports.ODIN_STREAMS.includes(stream)) {
            throw new Error(`Cannot parse Odin version (unknown stream "${stream}")`);
        }
        if (!YEAR_REGEX.test(year)) {
            throw new Error(`Cannot parse Odin version (invalid year "${year}")`);
        }
        if (!MONTH_REGEX.test(month)) {
            throw new Error(`Cannot parse Odin version (invalid month "${month}")`);
        }
        return [stream, year, month];
    },
    async getLatestRelease(octokit) {
        const release = await (0, utils_1.getRepositoryLatestRelease)({
            owner: 'odin-lang',
            repo: 'odin'
        }, octokit);
        return m.parseVersion(release.tag_name);
    },
    async findRelease(version, octokit) {
        return await (0, utils_1.getRepositoryReleaseByTag)({
            owner: 'odin-lang',
            repo: 'odin',
            tag: version.join('-')
        }, octokit);
    },
    async downloadOdinRelease(version, destinationFolder, octokit) {
        let dlVersion = version;
        if (dlVersion === 'latest') {
            dlVersion = await m.getLatestRelease(octokit);
        }
        return (0, utils_1.downloadRepositoryReleaseAsset)({
            owner: 'odin-lang',
            repo: 'odin',
            asset_id: (await m.findRelease(dlVersion, octokit)).id
        }, destinationFolder, octokit);
    }
};
function getTestingModule() {
    return m;
}
exports.getTestingModule = getTestingModule;
exports.downloadOdinRelease = m.downloadOdinRelease, exports.findRelease = m.findRelease, exports.getLatestRelease = m.getLatestRelease, exports.parseVersion = m.parseVersion;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2Rpbi1yZXBvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL29kaW4tcmVwby50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFJQSxtQ0FNaUI7QUFlSixRQUFBLFlBQVksR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBS3BDLE1BQU0sV0FBVyxHQUFHLG1CQUFtQixDQUFDO0FBS3hDLE1BQU0sVUFBVSxHQUFHLFNBQVMsQ0FBQztBQU03QixNQUFNLENBQUMsR0FBRztJQTZCTixZQUFZLENBQUMsR0FBVztRQUNwQixNQUFNLEtBQUssR0FBRyxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzdCLElBQUksS0FBSyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUNyQixNQUFNLElBQUksS0FBSyxDQUNYLG1EQUFtRCxDQUN0RCxDQUFDO1FBQ04sQ0FBQztRQUNELE1BQU0sQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUNwQyxJQUFJLENBQUMsb0JBQVksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUNqQyxNQUFNLElBQUksS0FBSyxDQUNYLDhDQUE4QyxNQUFNLElBQUksQ0FDM0QsQ0FBQztRQUNOLENBQUM7UUFDRCxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQ3pCLE1BQU0sSUFBSSxLQUFLLENBQ1gsNENBQTRDLElBQUksSUFBSSxDQUN2RCxDQUFDO1FBQ04sQ0FBQztRQUNELElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDM0IsTUFBTSxJQUFJLEtBQUssQ0FDWCw2Q0FBNkMsS0FBSyxJQUFJLENBQ3pELENBQUM7UUFDTixDQUFDO1FBQ0QsT0FBTyxDQUFDLE1BQW9CLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFRCxLQUFLLENBQUMsZ0JBQWdCLENBQUMsT0FBZ0I7UUFDbkMsTUFBTSxPQUFPLEdBQUcsTUFBTSxJQUFBLGtDQUEwQixFQUM1QztZQUNJLEtBQUssRUFBRSxXQUFXO1lBQ2xCLElBQUksRUFBRSxNQUFNO1NBQ2YsRUFDRCxPQUFPLENBQ1YsQ0FBQztRQUNGLE9BQU8sQ0FBQyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVELEtBQUssQ0FBQyxXQUFXLENBQ2IsT0FBb0IsRUFDcEIsT0FBZ0I7UUFFaEIsT0FBTyxNQUFNLElBQUEsaUNBQXlCLEVBQ2xDO1lBQ0ksS0FBSyxFQUFFLFdBQVc7WUFDbEIsSUFBSSxFQUFFLE1BQU07WUFDWixHQUFHLEVBQUUsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7U0FDekIsRUFDRCxPQUFPLENBQ1YsQ0FBQztJQUNOLENBQUM7SUFFRCxLQUFLLENBQUMsbUJBQW1CLENBQ3JCLE9BQStCLEVBQy9CLGlCQUEyQixFQUMzQixPQUFnQjtRQUVoQixJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUM7UUFDeEIsSUFBSSxTQUFTLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDekIsU0FBUyxHQUFHLE1BQU0sQ0FBQyxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2xELENBQUM7UUFFRCxPQUFPLElBQUEsc0NBQThCLEVBQ2pDO1lBQ0ksS0FBSyxFQUFFLFdBQVc7WUFDbEIsSUFBSSxFQUFFLE1BQU07WUFDWixRQUFRLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRTtTQUN6RCxFQUNELGlCQUFpQixFQUNqQixPQUFPLENBQ1YsQ0FBQztJQUNOLENBQUM7Q0FDSixDQUFDO0FBU0YsU0FBZ0IsZ0JBQWdCO0lBQzVCLE9BQU8sQ0FBQyxDQUFDO0FBQ2IsQ0FBQztBQUZELDRDQUVDO0FBSUcsMkJBQW1CLEdBSW5CLENBQUMsc0JBSEQsbUJBQVcsR0FHWCxDQUFDLGNBRkQsd0JBQWdCLEdBRWhCLENBQUMsbUJBREQsb0JBQVksR0FDWixDQUFDLGNBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLy0tIE5vZGVKU1xuaW1wb3J0IHtQYXRoTGlrZX0gZnJvbSAnbm9kZTpmcyc7XG5cbi8vLS0gUHJvamVjdCBDb2RlXG5pbXBvcnQge1xuICAgIGRvd25sb2FkUmVwb3NpdG9yeVJlbGVhc2VBc3NldCxcbiAgICBnZXRSZXBvc2l0b3J5TGF0ZXN0UmVsZWFzZSxcbiAgICBnZXRSZXBvc2l0b3J5UmVsZWFzZUJ5VGFnLFxuICAgIE9jdG9raXQsXG4gICAgUmVsZWFzZVxufSBmcm9tICcuL3V0aWxzJztcblxuLyoqXG4gKiBBIHR5cGUgZGVmaW5pbmcga25vd24gT2RpbiB2ZXJzaW9uIHN0cmVhbXMuXG4gKi9cbmV4cG9ydCB0eXBlIE9kaW5TdHJlYW0gPSAnZGV2JztcblxuLyoqXG4gKiBBIHR5cGUgd2hpY2ggZGVmaW5lcyB0aGUgZm9ybWF0IG9mIGFuIE9kaW4gcmVsZWFzZS5cbiAqL1xuZXhwb3J0IHR5cGUgT2RpblZlcnNpb24gPSBbT2RpblN0cmVhbSwgc3RyaW5nLCBzdHJpbmddO1xuXG4vKipcbiAqIEFuIGFycmF5IGRlZmluaW5nIGtub3duIE9kaW4gdmVyc2lvbiBzdHJlYW1zLlxuICovXG5leHBvcnQgY29uc3QgT0RJTl9TVFJFQU1TID0gWydkZXYnXTtcblxuLyoqXG4gKiBBIHJlZ3VsYXIgZXhwcmVzc2lvbiBmb3IgdmFsaWRhdGluZyBtb250aCBudW1iZXJzLlxuICovXG5jb25zdCBNT05USF9SRUdFWCA9IC9eKDBbMS05XXwxWzEtMl0pJC87XG5cbi8qKlxuICogQSByZWd1bGFyIGV4cHJlc3Npb24gZm9yIHZhbGlkYXRpbmcgeWVhciBudW1iZXJzLlxuICovXG5jb25zdCBZRUFSX1JFR0VYID0gL15cXGR7NH0kLztcblxuLyoqXG4gKiBBIG1vZHVsZSB3aGljaCBwcm92aWRlcyBhIHV0aWxpdHkgZnVuY3Rpb25hbGl0eSByZWxhdGVkIHRvIHRoZSBPZGluXG4gKiByZXBvc2l0b3J5LlxuICovXG5jb25zdCBtID0ge1xuICAgIC8qKlxuICAgICAqIFBhcnNlIGEgc3RyaW5nIGludG8gYW4gT2RpbiB2ZXJzaW9uLlxuICAgICAqXG4gICAgICogQW4gT2RpbiB2ZXJzaW9uIGlzIGEgc3RyaW5nIGluIHRoZSBmb2xsb3dpbmcgZm9ybWF0OlxuICAgICAqXG4gICAgICogYGBgYm5mXG4gICAgICogPG9kaW4tdmVyc2lvbj4gOj0gPHN0cmVhbT4gXCItXCIgPHllYXI+IFwiLVwiIDxtb250aD5cbiAgICAgKiA8c3RyZWFtPiA6PSBcImRldlwiXG4gICAgICogPHllYXI+IDo9IDxkaWdpdD4gPGRpZ2l0PiA8ZGlnaXQ+IDxkaWdpdD5cbiAgICAgKiA8bW9udGg+IDo9IFwiMFwiIDxtb250aC1kaWdpdD4gfCBcIjFcIiA8bW9udGgtZGlnaXQtMj5cbiAgICAgKiA8bW9udGgtZGlnaXQ+IDo9IFwiMVwiIHwgXCIyXCIgfCBcIjNcIiB8IFwiNFwiIHwgXCI1XCIgfCBcIjZcIiB8IFwiN1wiIHwgXCI4XCIgfCBcIjlcIlxuICAgICAqIDxtb250aC1kaWdpdC0yPiA6PSBcIjFcIiB8IFwiMlwiXG4gICAgICogPGRpZ2l0PiA6PSBcIjBcIiB8IFwiMVwiIHwgXCIyXCIgfCBcIjNcIiB8IFwiNFwiIHwgXCI1XCIgfCBcIjZcIiB8IFwiN1wiIHwgXCI4XCIgfCBcIjlcIlxuICAgICAqIGBgYFxuICAgICAqXG4gICAgICogQHBhcmFtIHN0ciAtIFRoZSBzdHJpbmcgdG8gcGFyc2UuXG4gICAgICpcbiAgICAgKiBAcmV0dXJucyBBbiBPZGluIHZlcnNpb24uXG4gICAgICpcbiAgICAgKiBAdGhyb3dzIGBFcnJvcmBcbiAgICAgKiBUaHJvd24gaWYgdGhlIHN0cmluZyBjb250YWlucyB0aGUgd3JvbmcgbnVtYmVyIG9mIHBhcnRzLlxuICAgICAqIEB0aHJvd3MgYEVycm9yYFxuICAgICAqIFRocm93biBpZiB0aGUgc3RyZWFtIGNvbXBvbmVudCBpcyBub3QgYSBrbm93biBPZGluIHN0cmVhbS5cbiAgICAgKiBAdGhyb3dzIGBFcnJvcmBcbiAgICAgKiBUaHJvd24gaWYgdGhlIHllYXIgY29tcG9uZW50IGlzIG5vdCBhIHZhbGlkIHllYXIgbnVtYmVyLlxuICAgICAqIEB0aHJvd3MgYEVycm9yYFxuICAgICAqIFRocm93biBpZiB0aGUgbW9udGggY29tcG9uZW50IGlzIG5vdCBhIHZhbGlkIG1vbnRoIG51bWJlci5cbiAgICAgKi9cbiAgICBwYXJzZVZlcnNpb24oc3RyOiBzdHJpbmcpOiBPZGluVmVyc2lvbiB7XG4gICAgICAgIGNvbnN0IHNwbGl0ID0gc3RyLnNwbGl0KCctJyk7XG4gICAgICAgIGlmIChzcGxpdC5sZW5ndGggIT09IDMpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICAgICAnQ2Fubm90IHBhcnNlIE9kaW4gdmVyc2lvbiAod3JvbmcgbnVtYmVyIG9mIHBhcnRzKSdcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgW3N0cmVhbSwgeWVhciwgbW9udGhdID0gc3BsaXQ7XG4gICAgICAgIGlmICghT0RJTl9TVFJFQU1TLmluY2x1ZGVzKHN0cmVhbSkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICAgICBgQ2Fubm90IHBhcnNlIE9kaW4gdmVyc2lvbiAodW5rbm93biBzdHJlYW0gXCIke3N0cmVhbX1cIilgXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGlmICghWUVBUl9SRUdFWC50ZXN0KHllYXIpKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgYENhbm5vdCBwYXJzZSBPZGluIHZlcnNpb24gKGludmFsaWQgeWVhciBcIiR7eWVhcn1cIilgXG4gICAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICAgIGlmICghTU9OVEhfUkVHRVgudGVzdChtb250aCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAgICAgICBgQ2Fubm90IHBhcnNlIE9kaW4gdmVyc2lvbiAoaW52YWxpZCBtb250aCBcIiR7bW9udGh9XCIpYFxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gW3N0cmVhbSBhcyBPZGluU3RyZWFtLCB5ZWFyLCBtb250aF07XG4gICAgfSxcblxuICAgIGFzeW5jIGdldExhdGVzdFJlbGVhc2Uob2N0b2tpdDogT2N0b2tpdCk6IFByb21pc2U8T2RpblZlcnNpb24+IHtcbiAgICAgICAgY29uc3QgcmVsZWFzZSA9IGF3YWl0IGdldFJlcG9zaXRvcnlMYXRlc3RSZWxlYXNlKFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG93bmVyOiAnb2Rpbi1sYW5nJyxcbiAgICAgICAgICAgICAgICByZXBvOiAnb2RpbidcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvY3Rva2l0XG4gICAgICAgICk7XG4gICAgICAgIHJldHVybiBtLnBhcnNlVmVyc2lvbihyZWxlYXNlLnRhZ19uYW1lKTtcbiAgICB9LFxuXG4gICAgYXN5bmMgZmluZFJlbGVhc2UoXG4gICAgICAgIHZlcnNpb246IE9kaW5WZXJzaW9uLFxuICAgICAgICBvY3Rva2l0OiBPY3Rva2l0XG4gICAgKTogUHJvbWlzZTxSZWxlYXNlPiB7XG4gICAgICAgIHJldHVybiBhd2FpdCBnZXRSZXBvc2l0b3J5UmVsZWFzZUJ5VGFnKFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG93bmVyOiAnb2Rpbi1sYW5nJyxcbiAgICAgICAgICAgICAgICByZXBvOiAnb2RpbicsXG4gICAgICAgICAgICAgICAgdGFnOiB2ZXJzaW9uLmpvaW4oJy0nKVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG9jdG9raXRcbiAgICAgICAgKTtcbiAgICB9LFxuXG4gICAgYXN5bmMgZG93bmxvYWRPZGluUmVsZWFzZShcbiAgICAgICAgdmVyc2lvbjogT2RpblZlcnNpb24gfCAnbGF0ZXN0JyxcbiAgICAgICAgZGVzdGluYXRpb25Gb2xkZXI6IFBhdGhMaWtlLFxuICAgICAgICBvY3Rva2l0OiBPY3Rva2l0XG4gICAgKTogUHJvbWlzZTxQYXRoTGlrZT4ge1xuICAgICAgICBsZXQgZGxWZXJzaW9uID0gdmVyc2lvbjtcbiAgICAgICAgaWYgKGRsVmVyc2lvbiA9PT0gJ2xhdGVzdCcpIHtcbiAgICAgICAgICAgIGRsVmVyc2lvbiA9IGF3YWl0IG0uZ2V0TGF0ZXN0UmVsZWFzZShvY3Rva2l0KTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBkb3dubG9hZFJlcG9zaXRvcnlSZWxlYXNlQXNzZXQoXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgb3duZXI6ICdvZGluLWxhbmcnLFxuICAgICAgICAgICAgICAgIHJlcG86ICdvZGluJyxcbiAgICAgICAgICAgICAgICBhc3NldF9pZDogKGF3YWl0IG0uZmluZFJlbGVhc2UoZGxWZXJzaW9uLCBvY3Rva2l0KSkuaWRcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBkZXN0aW5hdGlvbkZvbGRlcixcbiAgICAgICAgICAgIG9jdG9raXRcbiAgICAgICAgKTtcbiAgICB9XG59O1xuXG4vKipcbiAqIEdldCB0aGUgaW50ZXJuYWwgbW9kdWxlIGZvciB1c2Ugd2l0aCB1bml0IHRlc3RpbmcuXG4gKlxuICogQHJldHVybnMgVGhlIGludGVybmFsIG1vZHVsZS5cbiAqXG4gKiBAaW50ZXJuYWxcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldFRlc3RpbmdNb2R1bGUoKTogdHlwZW9mIG0ge1xuICAgIHJldHVybiBtO1xufVxuXG4vKiBlc2xpbnQtZGlzYWJsZSBuby1lbXB0eS1wYXR0ZXJuLCBAdHlwZXNjcmlwdC1lc2xpbnQvdW5ib3VuZC1tZXRob2QgKi9cbmV4cG9ydCBjb25zdCB7XG4gICAgZG93bmxvYWRPZGluUmVsZWFzZSxcbiAgICBmaW5kUmVsZWFzZSxcbiAgICBnZXRMYXRlc3RSZWxlYXNlLFxuICAgIHBhcnNlVmVyc2lvblxufSA9IG07XG4vKiBlc2xpbnQtZW5hYmxlIG5vLWVtcHR5LXBhdHRlcm4sIEB0eXBlc2NyaXB0LWVzbGludC91bmJvdW5kLW1ldGhvZCAqL1xuIl19